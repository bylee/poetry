<!DOCTYPE HTML>
<html lang="utf-8">
<head>
<meta charset="UTF-8">
	<title>Admin page</title>
	<link rel="stylesheet" href="../../css/datepicker.css" />
	
	<script type="text/javascript" src="../../js/load-image.js"></script>
	<script type="text/javascript" src="../../js/bootstrap-datepicker.js"></script>
</head>
<body>
<form id="fileupload" action="../../mission" method="post" enctype="multipart/form-data">
	<input type="file" id="uploadFile" name="uploadFile" style="visibility: hidden;" hidden="true">
	<div class="container">
	<div class="row">
		<div class="span4" id="dateContainer">
		</div>
	</div>
	<div class="row">
	    <div class="span6 fileupload-buttonbar" id="imageContainer">
			<img id="image" alt="" src="" width="100%" height="300">
		</div>
	</div>
	<div class="row">
		<div class="span1">Description</div>
	</div>
	<div class="row">
		<div class="span6">
			<input type="hidden" id="imageId" name="imageId" >
			<textarea id="description" name="description" cols="200" style="width: 100%"></textarea>
		</div>
	</div>
	<div class="row">
	<button id="send" disabled="disabled" class="btn btn-primary">등록하기</button>
	</div>
	</div>
</form>
</body>
	<script id="date-template" type="template/jquery">
		<input name="{{cid}}" type="text">
	</div>
	</script>
	
	<script id="imageUpload-template" type="template/jquery">
	    <div class="span6 fileupload-buttonbar">
			<img width="100%" height="300">
		</div>
	</script>
	
	

<script type="text/javascript">
function load( date ) {
	url = "../../mission/" + convert( date );
	console.log( "trying "+url + " for " + date );
	$.ajax( {
		type : "GET",
		dataType: "json",
		url : url,
		success: function( json )  
		{
			var id = "";
			image = $( "#imageContainer>img" );
			if ( json ) {
				id = json.imageId;
				image.attr( "src", "../../binary/" + id );
				$( "#imageId" ).val( json.id );
				$( "#description" ).val( json.description );
				$( "#send" ).removeAttr( "disabled" );
			} else {
				image.attr( "src", "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" );
				$( "#imageId" ).val( "" );
				$( "#send" ).attr( "disabled", "disabled" );
				$( "#description" ).val( "" );
			}
			console.log( "Request image :%s", id );
			return false;
		},
		error: function( e )
		{
			alert( "미션을 가져오지 못했습니다. :" + e );
			return false;
		}
		
	} );
	if ( date.valueOf() < new Date() ) {
		alert( "수정할 수 없는 미션의 날짜입니다." );
	}
}
function convert( date ) 
{
	var d = date.getDate();
	var m = date.getMonth() + 1;
	var dd = ( d < 10 ? '0' : '') + d;
	var mm = ( m < 10 ? '0' : '') + m;
	
	return date.getFullYear() + "-" + mm + "-" + dd;
};
$( function() {
	
	var now = new Date();
	var tomorrow = new Date( now.getTime() + (24 * 60 * 60 * 1000))
	
	var date = new Calendar( {
		date : tomorrow,
		changeDate: function( ev ) {
			load( ev.date );
		}
	} );
	new CalendarView( { el: $( "#dateContainer" ), model: date, format: "yyyy-mm-dd" } ).render();
	
    var result = $( '#imageContainer' ),
    loadImage = function (e) {
        e = e.originalEvent;
        e.preventDefault();
        window.loadImage(
            (e.dataTransfer || e.target).files[0],
            function (img) {
            	$( "#send" ).removeAttr( "disabled" );
				$( "#description" ).val( "" );
                result.children().replaceWith(img);
            },
            {
                maxWidth: result.children().outerWidth(),
                canvas: true
            }
        );
    };
	
	$( '#date' ).val( convert( tomorrow ) );
	$( '#date' ).datepicker( { "format" : "yyyy-mm-dd" } ).on( "changeDate", function( ev ) {
		load( ev.date );
	} );

	$( "#imageContainer" ).click( function(){ $( "#uploadFile" ).click(); } );
	$( "#uploadFile" ).change( loadImage );

	$( "#fileupload" ).ajaxForm( {
		scriptCharset: "utf-8" ,
		contentType: "multipart/form-data; charset=UTF-8",
		success : function() {
			alert( "미션을 성공적으로 등록하였습니다." );
			
		}
		
	} );
	
	$( "#fileupload" ).ajaxForm( {
		dataType : "json",
		success : function( json ) {
			console.log( "Request image :%s", json.id );
			$( "#imageContainer>img" ).attr( "src", "../../binary/" + json.id );
			$( "#imageId" ).val( json.id );
		}
	} );
	
	
	$(document).on( 'dragover', function (e) {
        e = e.originalEvent;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    } ).on('drop', loadImage );
	load( tomorrow );
});
</script>
</html>